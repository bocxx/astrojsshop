---
import Layout from '../layouts/Layout.astro';
import { PhotoDB } from '../lib/db';

// Access Cloudflare bindings with fallback
const runtime = Astro.locals.runtime;
if (!runtime?.env?.DB || !runtime?.env?.PHOTOS) {
  console.error('Missing Cloudflare bindings', {
    hasRuntime: !!runtime,
    hasDB: !!runtime?.env?.DB,
    hasPHOTOS: !!runtime?.env?.PHOTOS
  });
  return new Response('Configuration error', { status: 500 });
}

const db = new PhotoDB(
  runtime.env.DB,
  runtime.env.PHOTOS
);

const user = Astro.locals.user;

// Redirect to login if not authenticated
if (!user) {
  return Astro.redirect('/login');
}

const INITIAL_LOAD = 20;
const photos = await db.getAvailablePhotos(INITIAL_LOAD, 0);
const totalPhotos = await db.getAvailablePhotosCount();
const initialHasMore = totalPhotos > INITIAL_LOAD;
---

<Layout title="Fotogalerij">
  <div class="min-h-screen pb-24">
    <!-- Party Logo & Support -->
    <div class="mb-8 text-center space-y-4">
      <div class="flex justify-center">
        <img 
          src="/logo.png" 
          alt="Samen voor Krimpen" 
          class="h-32 w-auto"
        />
      </div>
      <p class="text-xl font-bold text-[--color-brand-blue]">
        Steun de partij!
      </p>
    </div>

    <!-- Photographer Credit -->
    <div class="mb-6 text-center">
      <p class="text-sm text-[--color-brand-blue]/70">
        Foto's gemaakt door{' '}
        <a 
          href="https://www.facebook.com/martien.slingerland" 
          target="_blank" 
          rel="noopener noreferrer"
          class="font-semibold text-[--color-brand-purple] hover:text-[--color-brand-coral] transition-colors underline decoration-dotted underline-offset-2"
        >
          Martien Slingerland
        </a>
      </p>
    </div>

    <!-- Header -->
    <header class="mb-8">
      <div class="flex items-center justify-between gap-4 flex-wrap">

        <!-- Title Section -->
        <div class="space-y-2">
          <h1 class="text-4xl font-bold bg-gradient-to-r from-[--color-brand-blue] via-[--color-brand-purple] to-[--color-brand-coral] bg-clip-text text-transparent">
            SvK Shop
          </h1>
          <p class="text-lg font-bold text-[--color-brand-blue] tracking-tight">
            Selecteer de foto's die je wilt bestellen
          </p>
        </div>

        <!-- Photo Counter Badge -->
        <div class="px-5 py-2.5 text-sm font-semibold text-[--color-brand-blue] bg-gradient-to-br from-[--color-brand-purple]/5 via-[--color-brand-coral]/5 to-[--color-brand-blue]/5 border border-[--color-brand-purple]/20 rounded-2xl shadow-sm backdrop-blur-sm">
          <span id="photoCount">{totalPhotos}</span> foto's
        </div>

      </div>
    </header>

    <!-- Photo Grid -->
    <div id="photoGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-x-4 gap-y-28 lg:gap-y-16">
      {photos.map((photo) => (
        <article class="photo-card group relative h-48 flex flex-col rounded-xl bg-white bg-clip-border text-gray-700 shadow-md hover:shadow-xl transition-shadow duration-300">
          <!-- Image Container -->
          <div class="h-28">
            <div class="absolute -top-20 lg:-top-[10%] left-[5%] z-10 w-[90%] h-48 bg-gradient-to-br from-[--color-brand-blue] via-[--color-brand-purple] to-[--color-brand-coral] rounded-xl flex items-center justify-center overflow-hidden shadow-lg group-hover:shadow-2xl group-hover:-translate-y-1 transition-all duration-300">
              <img
                src={`/api/photos/thumb/${photo.id}`}
                alt={photo.name}
                class="w-full h-full object-cover select-none pointer-events-none"
                loading="lazy"
                draggable="false"
                oncontextmenu="return false;"
              />
              <!-- Watermark overlay -->
              <div class="absolute top-2 right-2 text-white/80 text-[10px] font-medium bg-black/40 px-2 py-1 rounded backdrop-blur-sm pointer-events-none z-30">
                © Samen voor Krimpen
              </div>
              <!-- Clickable overlay for lightbox -->
              <div
                class="photo-preview absolute inset-0 cursor-pointer z-20"
                data-photo-id={photo.id}
                data-photo-name={photo.name}
              ></div>
            </div>
          </div>

          <!-- Content - Button Only -->
          <div class="p-4 z-30 w-full relative flex items-center justify-center">
            <button class="add-to-cart group/btn relative px-4 py-2 text-xs font-semibold text-gray-800 bg-white rounded-xl overflow-hidden transition-all duration-300 hover:shadow-xl hover:shadow-[--color-brand-purple]/40 hover:scale-[1.02] active:scale-95 flex items-center justify-center gap-1.5 shadow-lg border-2 border-[--color-brand-purple]/30 backdrop-blur-sm" data-photo-id={photo.id} data-photo-name={photo.name}>
              <span class="relative z-10 flex items-center gap-1.5">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                </svg>
                <span class="tracking-wide">Bestellen</span>
              </span>
            </button>
          </div>
        </article>
      ))}
    </div>

    <!-- Loading Skeleton -->
    <div id="loadingSpinner" class="hidden mt-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-x-4 gap-y-28 lg:gap-y-16">
      {[...Array(5)].map(() => (
        <div class="animate-pulse relative h-48 flex flex-col rounded-xl bg-white shadow-md">
          <div class="h-28">
            <div class="absolute -top-20 lg:-top-[10%] left-[5%] w-[90%] h-48 bg-gradient-to-br from-[--color-brand-purple]/20 to-[--color-brand-coral]/20 rounded-xl"></div>
          </div>
          <div class="p-6 space-y-3 mt-auto">
            <div class="h-5 bg-[--color-brand-purple]/10 rounded-lg w-3/4 mx-auto"></div>
            <div class="h-9 bg-[--color-brand-purple]/10 rounded-xl"></div>
          </div>
        </div>
      ))}
    </div>

    <div id="scrollTrigger" class="h-10"></div>

    <!-- Floating Cart Button -->
    <a
      href="/cart"
      id="cartToggle"
      class="fixed bottom-8 right-8 z-40 hidden p-6 text-white bg-gradient-to-br from-[--color-brand-blue] via-[--color-brand-purple] to-[--color-brand-coral] rounded-full shadow-2xl transition-all duration-500 hover:shadow-[--color-brand-purple]/70 hover:scale-110 active:scale-95 group border-4 border-white/30 backdrop-blur-sm"
    >
      <!-- Pulse ring effect -->
      <div class="absolute inset-0 rounded-full bg-gradient-to-br from-[--color-brand-blue] to-[--color-brand-coral] animate-ping opacity-20"></div>

      <!-- Rotating gradient background -->
      <div class="absolute inset-0 rounded-full bg-gradient-to-br from-[--color-brand-coral] via-[--color-brand-purple] to-[--color-brand-blue] opacity-0 group-hover:opacity-100 transition-opacity duration-500 group-hover:animate-spin-slow"></div>

      <div class="relative z-10">
        <svg class="w-7 h-7 group-hover:scale-110 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
        </svg>
        <span id="cartBadge" class="absolute -top-3 -right-3 bg-gradient-to-r from-[--color-brand-coral] to-red-500 text-white text-xs font-black rounded-full min-w-[1.75rem] h-7 flex items-center justify-center px-2 shadow-xl border-3 border-white animate-bounce">0</span>
      </div>
    </a>

    <!-- Enhanced Lightbox -->
    <div id="lightbox" class="fixed inset-0 z-[60] hidden opacity-0 bg-black/90 backdrop-blur-md transition-all duration-300 flex flex-col">
      <!-- Close Button -->
      <button id="closeLightbox" class="absolute top-6 right-6 text-white/80 hover:text-white bg-white/10 hover:bg-white/20 backdrop-blur-md p-3 rounded-2xl transition-all duration-300 hover:scale-110 z-50">
        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
      
      <!-- Navigation Hints -->
      <div class="absolute top-6 left-6 text-white/60 text-sm bg-white/10 backdrop-blur-md px-4 py-2 rounded-2xl z-50 hidden md:block">
        <span>ESC om te sluiten • ← → om te navigeren</span>
      </div>
      
      <!-- Mobile Swipe Hint -->
      <div class="absolute top-6 left-1/2 -translate-x-1/2 text-white/60 text-xs bg-white/10 backdrop-blur-md px-4 py-2 rounded-full z-50 md:hidden flex items-center space-x-2 animate-pulse">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16l-4-4m0 0l4-4m-4 4h18"></path>
        </svg>
        <span>Swipe om te navigeren</span>
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
        </svg>
      </div>

      <!-- Left Navigation Area (clickable) -->
      <button id="prevPhoto" class="absolute left-0 top-0 h-full w-1/4 cursor-pointer z-30 group" aria-label="Vorige foto">
        <div class="absolute left-4 top-1/2 -translate-y-1/2 bg-white/10 hover:bg-white/20 backdrop-blur-md p-4 rounded-full transition-all duration-300 opacity-0 group-hover:opacity-100">
          <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
        </div>
      </button>

      <!-- Right Navigation Area (clickable) -->
      <button id="nextPhoto" class="absolute right-0 top-0 h-full w-1/4 cursor-pointer z-30 group" aria-label="Volgende foto">
        <div class="absolute right-4 top-1/2 -translate-y-1/2 bg-white/10 hover:bg-white/20 backdrop-blur-md p-4 rounded-full transition-all duration-300 opacity-0 group-hover:opacity-100">
          <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </div>
      </button>

      <!-- Center Content - Image Area (flex-1 to take available space) -->
      <div class="flex-1 flex items-center justify-center w-full p-4 pb-0 overflow-hidden">
        <div id="lightboxImageContainer" class="relative rounded-3xl overflow-hidden shadow-2xl bg-white/5 backdrop-blur-sm border border-white/10 p-2 touch-pan-y max-w-full max-h-full">
          <img id="lightboxImage" src="" alt="" class="max-w-full max-h-[calc(100vh-250px)] md:max-h-[calc(100vh-200px)] object-contain rounded-2xl select-none" draggable="false" oncontextmenu="return false;" />
          <!-- Watermark on lightbox image -->
          <div class="absolute top-4 right-4 text-white/90 text-sm font-semibold bg-black/50 px-3 py-1.5 rounded-lg backdrop-blur-md pointer-events-none z-30 shadow-lg">
            © Samen voor Krimpen
          </div>
        </div>
      </div>

      <!-- Bottom Action Bar - Fixed at bottom -->
      <div class="w-full bg-gradient-to-t from-black via-black/95 to-transparent pt-8 pb-safe z-50">
        <div class="max-w-2xl mx-auto px-4 pb-4 space-y-3">
          <h2 id="lightboxTitle" class="text-lg md:text-2xl font-bold text-white text-center truncate"></h2>
          <button id="lightboxAddToCart" class="w-full px-6 py-4 bg-gradient-to-r from-[--color-brand-coral] to-[--color-brand-purple] text-white rounded-2xl hover:shadow-2xl hover:shadow-[--color-brand-coral]/50 active:scale-95 transition-all duration-300 font-bold flex items-center justify-center space-x-3 text-lg shadow-2xl border-2 border-white/20">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
            </svg>
            <span>Toevoegen aan Winkelwagen</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-24 right-6 z-[70] space-y-3 pointer-events-none"></div>
  </div>

  <script is:inline define:vars={{ initialHasMore, totalPhotos, initialPhotoCount: photos.length }}>
    window.__INITIAL_STATE__ = {
      hasMorePhotos: initialHasMore,
      totalPhotos: totalPhotos,
      initialPhotoCount: initialPhotoCount
    };
  </script>

  <script>
    import { actions } from 'astro:actions';

    // Type declaration for window
    declare global {
      interface Window {
        __INITIAL_STATE__: {
          hasMorePhotos: boolean;
          totalPhotos: number;
          initialPhotoCount: number;
        };
      }
    }

    // Prevent image downloads and right-click
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('img').forEach((img) => {
        img.addEventListener('contextmenu', (e) => e.preventDefault());
        img.addEventListener('dragstart', (e) => e.preventDefault());
      });

      document.addEventListener('keydown', (e) => {
        if (e.metaKey && e.shiftKey && ['3', '4', '5'].includes(e.key)) {
          e.preventDefault();
        }
        if (e.key === 'PrintScreen') {
          e.preventDefault();
        }
      });
    });

    const cart = new Map<string, { id: string; name: string; quantity: number }>();
    let currentLightboxPhoto: { id: string; name: string } | null = null;
    let cartVisible = false;

    // Infinite scroll state
    let currentOffset = 20;
    let isLoading = false;
    let hasMorePhotos = window.__INITIAL_STATE__.hasMorePhotos;
    const PHOTOS_PER_PAGE = 20;

    // Debug: Log initial state
    console.log('Initial state:', {
      totalPhotos: window.__INITIAL_STATE__.totalPhotos,
      initialLoad: window.__INITIAL_STATE__.initialPhotoCount,
      currentOffset,
      hasMorePhotos,
      PHOTOS_PER_PAGE
    });

    // Modern Toast Notification System
    function showToast(message: string, type: 'success' | 'error' | 'info' = 'success', duration = 4000) {
      const container = document.getElementById('toastContainer');
      if (!container) return;

      const toast = document.createElement('div');
      toast.className = `pointer-events-auto transform translate-x-96 transition-all duration-500 ease-out`;

      const colors = {
        success: 'from-[--color-brand-purple] to-[--color-brand-coral]',
        error: 'from-[--color-brand-coral] to-rose-500',
        info: 'from-[--color-brand-blue] to-[--color-brand-purple]'
      };

      const icons = {
        success: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>',
        error: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>',
        info: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>'
      };

      toast.innerHTML = `
        <div class="bg-gradient-to-r ${colors[type]} text-white px-4 py-3 rounded-xl shadow-2xl border-2 border-white/40 flex items-center space-x-2.5 max-w-sm">
          <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            ${icons[type]}
          </svg>
          <span class="font-semibold text-sm">${message}</span>
        </div>
      `;

      container.appendChild(toast);

      setTimeout(() => {
        toast.classList.remove('translate-x-96');
      }, 10);

      setTimeout(() => {
        toast.classList.add('translate-x-96', 'opacity-0');
        setTimeout(() => toast.remove(), 500);
      }, duration);
    }

    // Load cart from localStorage
    function loadCart() {
      const saved = localStorage.getItem('photo-cart');
      if (saved) {
        try {
          const data = JSON.parse(saved);
          data.forEach((item: any) => cart.set(item.id, item));
        } catch (e) {
          console.error('Failed to load cart', e);
        }
      }
    }

    // Save cart to localStorage
    function saveCart() {
      localStorage.setItem('photo-cart', JSON.stringify(Array.from(cart.values())));
    }

    function updateCart() {
      const cartBadge = document.getElementById('cartBadge');
      const mobileCartBadge = document.getElementById('mobileCartBadge');
      const cartToggle = document.getElementById('cartToggle');

      const totalItems = Array.from(cart.values()).reduce((sum, item) => sum + item.quantity, 0);
      
      if (cartBadge) cartBadge.textContent = totalItems.toString();
      if (mobileCartBadge) mobileCartBadge.textContent = totalItems.toString();

      // Show/hide toggle button
      if (cart.size === 0) {
        cartToggle?.classList.add('hidden');
      } else {
        cartToggle?.classList.remove('hidden');
      }

      saveCart();
    }

    // Load cart on page load
    loadCart();
    updateCart();

    // Add to cart functionality
    function attachAddToCartListener(button: Element) {
      button.addEventListener('click', (e) => {
        const target = e.target as HTMLElement;
        const btn = target.closest('button') as HTMLButtonElement;
        const photoId = btn.dataset.photoId!;
        const photoName = btn.dataset.photoName!;

        const existing = cart.get(photoId);
        if (existing) {
          existing.quantity++;
        } else {
          cart.set(photoId, { id: photoId, name: photoName, quantity: 1 });
        }

        // Button feedback animation
        const originalHTML = btn.innerHTML;
        const originalClasses = btn.className;
        btn.className = originalClasses.replace('from-[--color-brand-blue]', 'from-[--color-brand-purple]').replace('via-[--color-brand-purple]', 'via-[--color-brand-coral]');
        btn.innerHTML = `
          <span class="relative z-10 flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"></path>
            </svg>
            <span class="font-bold tracking-wide">Toegevoegd!</span>
          </span>
        `;

        setTimeout(() => {
          btn.innerHTML = originalHTML;
          btn.className = originalClasses;
        }, 1500);

        updateCart();
        showToast(`${photoName} toegevoegd aan winkelwagen`, 'success');
      });
    }

    // Attach listeners to initial cart buttons
    document.querySelectorAll('.add-to-cart').forEach(attachAddToCartListener);


    // Lightbox functionality
    const lightbox = document.getElementById('lightbox');
    const lightboxImage = document.getElementById('lightboxImage') as HTMLImageElement;
    const lightboxTitle = document.getElementById('lightboxTitle');
    const lightboxAddToCart = document.getElementById('lightboxAddToCart');
    const closeLightbox = document.getElementById('closeLightbox');
    const prevPhotoBtn = document.getElementById('prevPhoto');
    const nextPhotoBtn = document.getElementById('nextPhoto');

    // Get all photos for navigation
    let allPhotoElements: Element[] = [];
    let currentPhotoIndex = -1;

    function updatePhotoElements() {
      allPhotoElements = Array.from(document.querySelectorAll('.photo-preview'));
    }

    function openLightbox(photoId: string, photoName: string) {
      currentLightboxPhoto = { id: photoId, name: photoName };
      
      // Find current index
      currentPhotoIndex = allPhotoElements.findIndex(
        el => (el as HTMLElement).dataset.photoId === photoId
      );

      if (lightboxImage && lightboxTitle && lightbox) {
        console.log('Opening lightbox for:', photoName, photoId);
        lightboxImage.src = `/api/photos/${photoId}`;
        lightboxImage.alt = photoName;
        lightboxTitle.textContent = photoName;
        lightbox.classList.remove('hidden', 'opacity-0');
        lightbox.classList.add('flex');
        void lightbox.offsetHeight;
        lightbox.classList.add('opacity-100');
        document.body.style.overflow = 'hidden';
      }
    }

    function navigatePhoto(direction: 'prev' | 'next') {
      if (currentPhotoIndex === -1 || allPhotoElements.length === 0) return;

      const newIndex = direction === 'next' 
        ? (currentPhotoIndex + 1) % allPhotoElements.length
        : (currentPhotoIndex - 1 + allPhotoElements.length) % allPhotoElements.length;

      const newPhoto = allPhotoElements[newIndex] as HTMLElement;
      const photoId = newPhoto.dataset.photoId!;
      const photoName = newPhoto.dataset.photoName!;
      
      openLightbox(photoId, photoName);
    }

    function attachLightboxListener(preview: Element) {
      preview.addEventListener('click', (e) => {
        const target = e.currentTarget as HTMLElement;
        const photoId = target.dataset.photoId!;
        const photoName = target.dataset.photoName!;
        updatePhotoElements();
        openLightbox(photoId, photoName);
      });
    }

    document.querySelectorAll('.photo-preview').forEach(attachLightboxListener);

    const closeLightboxHandler = () => {
      if (lightbox) {
        lightbox.classList.remove('opacity-100');
        lightbox.classList.add('opacity-0');
        setTimeout(() => {
          lightbox.classList.add('hidden');
          lightbox.classList.remove('flex', 'opacity-0');
        }, 300);
        document.body.style.overflow = 'auto';
        currentLightboxPhoto = null;
        currentPhotoIndex = -1;
      }
    };

    closeLightbox?.addEventListener('click', closeLightboxHandler);
    prevPhotoBtn?.addEventListener('click', () => navigatePhoto('prev'));
    nextPhotoBtn?.addEventListener('click', () => navigatePhoto('next'));

    document.addEventListener('keydown', (e) => {
      if (!lightbox?.classList.contains('flex')) return;
      
      if (e.key === 'Escape') {
        closeLightboxHandler();
      } else if (e.key === 'ArrowLeft') {
        navigatePhoto('prev');
      } else if (e.key === 'ArrowRight') {
        navigatePhoto('next');
      }
    });

    // Touch/Swipe functionality for mobile
    let touchStartX = 0;
    let touchEndX = 0;
    let touchStartY = 0;
    let touchEndY = 0;
    const minSwipeDistance = 50;

    const lightboxImageContainer = document.getElementById('lightboxImageContainer');

    lightboxImageContainer?.addEventListener('touchstart', (e) => {
      touchStartX = e.touches[0].clientX;
      touchStartY = e.touches[0].clientY;
    }, { passive: true });

    lightboxImageContainer?.addEventListener('touchmove', (e) => {
      touchEndX = e.touches[0].clientX;
      touchEndY = e.touches[0].clientY;
    }, { passive: true });

    lightboxImageContainer?.addEventListener('touchend', () => {
      const swipeDistanceX = touchStartX - touchEndX;
      const swipeDistanceY = Math.abs(touchStartY - touchEndY);
      
      // Only trigger swipe if horizontal movement is greater than vertical (to allow vertical scrolling)
      if (Math.abs(swipeDistanceX) > minSwipeDistance && Math.abs(swipeDistanceX) > swipeDistanceY) {
        if (swipeDistanceX > 0) {
          // Swiped left - show next photo
          navigatePhoto('next');
        } else {
          // Swiped right - show previous photo
          navigatePhoto('prev');
        }
      }
    });

    // Hide mobile swipe hint after first interaction
    let hasInteracted = false;
    const hideSwipeHint = () => {
      if (!hasInteracted) {
        hasInteracted = true;
        const mobileHint = document.querySelector('.md\\:hidden.animate-pulse');
        if (mobileHint) {
          (mobileHint as HTMLElement).style.opacity = '0';
          setTimeout(() => mobileHint.remove(), 300);
        }
      }
    };

    lightboxImageContainer?.addEventListener('touchstart', hideSwipeHint, { once: true });
    prevPhotoBtn?.addEventListener('click', hideSwipeHint);
    nextPhotoBtn?.addEventListener('click', hideSwipeHint);

    lightboxAddToCart?.addEventListener('click', () => {
      if (currentLightboxPhoto) {
        const { id, name } = currentLightboxPhoto;

        const existing = cart.get(id);
        if (existing) {
          existing.quantity++;
        } else {
          cart.set(id, { id, name, quantity: 1 });
        }

        const btn = lightboxAddToCart as HTMLButtonElement;
        const originalHTML = btn.innerHTML;
        btn.innerHTML = `
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
          <span>Toegevoegd!</span>
        `;

        setTimeout(() => {
          btn.innerHTML = originalHTML;
        }, 1500);

        updateCart();
        showToast(`${name} toegevoegd aan winkelwagen`, 'success');
      }
    });

    // Infinite scroll
    function createPhotoCard(photo: any) {
      const card = document.createElement('div');
      card.className = 'photo-card group relative h-48 flex flex-col rounded-xl bg-white bg-clip-border text-gray-700 shadow-md hover:shadow-xl transition-shadow duration-300';

      card.innerHTML = `
        <div class="h-28">
          <div class="absolute -top-20 lg:-top-[10%] left-[5%] z-10 w-[90%] h-48 bg-gradient-to-br from-[--color-brand-blue] via-[--color-brand-purple] to-[--color-brand-coral] rounded-xl flex items-center justify-center overflow-hidden shadow-lg group-hover:shadow-2xl group-hover:-translate-y-1 transition-all duration-300">
            <img
              src="/api/photos/thumb/${photo.id}"
              alt="${photo.name}"
              class="w-full h-full object-cover select-none pointer-events-none"
              loading="lazy"
              draggable="false"
              oncontextmenu="return false;"
            />
            <!-- Watermark overlay -->
            <div class="absolute top-2 right-2 text-white/80 text-[10px] font-medium bg-black/40 px-2 py-1 rounded backdrop-blur-sm pointer-events-none z-30">
              © Samen voor Krimpen
            </div>
            <div
              class="photo-preview absolute inset-0 cursor-pointer z-20"
              data-photo-id="${photo.id}"
              data-photo-name="${photo.name}"
            ></div>
          </div>
        </div>
        <div class="p-4 z-30 w-full relative flex items-center justify-center">
          <button
            class="add-to-cart group/btn relative px-4 py-2 text-xs font-semibold text-gray-800 bg-white rounded-xl overflow-hidden transition-all duration-300 hover:shadow-xl hover:shadow-[--color-brand-purple]/40 hover:scale-[1.02] active:scale-95 flex items-center justify-center gap-1.5 shadow-lg border-2 border-[--color-brand-purple]/30 backdrop-blur-sm"
            data-photo-id="${photo.id}"
            data-photo-name="${photo.name}"
          >
            <span class="relative z-10 flex items-center gap-1.5">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
              </svg>
              <span class="tracking-wide">Bestellen</span>
            </span>
          </button>
        </div>
      `;

      const addToCartBtn = card.querySelector('.add-to-cart');
      if (addToCartBtn) {
        attachAddToCartListener(addToCartBtn);
      }

      const preview = card.querySelector('.photo-preview');
      if (preview) {
        attachLightboxListener(preview);
      }

      return card;
    }

    async function loadMorePhotos() {
      if (isLoading || !hasMorePhotos) {
        console.log('Skipping load:', { isLoading, hasMorePhotos });
        return;
      }

      console.log('Loading more photos from offset:', currentOffset);
      isLoading = true;
      const spinner = document.getElementById('loadingSpinner');
      spinner?.classList.remove('hidden');

      try {
        const response = await fetch(`/api/photos.json?limit=${PHOTOS_PER_PAGE}&offset=${currentOffset}`);
        const data = await response.json();
        console.log('Received photos:', data);

        if (data.photos && data.photos.length > 0) {
          const grid = document.getElementById('photoGrid');

          data.photos.forEach((photo: any) => {
            const card = createPhotoCard(photo);
            grid?.appendChild(card);
          });

          currentOffset += data.photos.length;
          hasMorePhotos = data.hasMore;
          console.log('Updated state:', { currentOffset, hasMorePhotos });
        } else {
          hasMorePhotos = false;
          console.log('No more photos available');
        }
      } catch (error) {
        console.error('Failed to load more photos:', error);
      } finally {
        isLoading = false;
        spinner?.classList.add('hidden');
      }
    }

    const scrollTrigger = document.getElementById('scrollTrigger');
    if (scrollTrigger) {
      console.log('Setting up intersection observer for infinite scroll');
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            console.log('Intersection observer triggered:', {
              isIntersecting: entry.isIntersecting,
              isLoading,
              hasMorePhotos
            });
            if (entry.isIntersecting && !isLoading && hasMorePhotos) {
              console.log('Triggering loadMorePhotos');
              loadMorePhotos();
            }
          });
        },
        {
          root: null,
          rootMargin: '200px',
          threshold: 0.1
        }
      );

      observer.observe(scrollTrigger);
      console.log('Observer attached to scrollTrigger');
    } else {
      console.error('scrollTrigger element not found!');
    }
  </script>
</Layout>
